{% comment %}
  Main Product Section - High-Converting DTC Design
  Based on visual_spec.md and DTC best practices
{% endcomment %}

<div class="w-full min-h-screen bg-background text-text">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 sm:py-12">    
    {%- comment -%} Product Grid - Image left, Info right, stacked on mobile {%- endcomment -%}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 mt-6">
      
      {%- comment -%} Left: Product Image Gallery {%- endcomment -%}
      <div class="product-images">
        {% assign selected_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media %}
        {% assign selected_media_id = selected_media.id %}
        
        {% if product.media.size > 0 %}
          <div class="lg:hidden mb-4">
            <div class="flex gap-4 overflow-x-auto overflow-y-hidden overscroll-x-contain overscroll-y-none snap-x snap-mandatory scroll-px-4 pb-2" data-thumbnail-track>
              {% if selected_media %}
                <div class="relative rounded-2xl overflow-hidden snap-start shrink-0 bg-background mobile-gallery__item">
                  <img
                    src="{{ selected_media.preview_image | image_url: width: 900 }}"
                    alt="{{ selected_media.alt | default: product.title }}"
                    loading="lazy"
                    class="w-full aspect-square object-cover"
                    data-variant-thumbnail
                  >
                </div>
              {% endif %}
              
              {% for media in product.media %}
                {% if selected_media and media.id == selected_media_id %}
                  {% continue %}
                {% endif %}
                <div class="relative rounded-2xl overflow-hidden snap-start shrink-0 bg-background mobile-gallery__item">
                  <img
                    src="{{ media.preview_image | image_url: width: 900 }}"
                    alt="{{ media.alt | default: product.title }}"
                    loading="lazy"
                    class="w-full aspect-square object-cover"
                  >
                  {% if media.media_type == 'video' or media.media_type == 'external_video' %}
                    <div class="absolute inset-0 flex items-center justify-center bg-black/25">
                      <svg class="w-9 h-9 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
                      </svg>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
        {% endif %}
        
        {% if product.media.size > 0 %}
          <product-gallery-component 
            class="product-gallery space-y-4 hidden lg:block"
          >
            {%- comment -%} Main Image - rounded-lg 8px {%- endcomment -%}
            <div class="main-image relative cursor-pointer bg-background rounded-lg overflow-hidden" ref="mainImage" data-product-gallery-main>
              {% assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media %}
              
              <img
                src="{{ featured_media | image_url: width: 1200 }}"
                alt="{{ featured_media.alt | default: product.title }}"
                width="1200"
                height="1200"
                loading="eager"
                class="w-full aspect-square object-cover transition-transform duration-300 hover:scale-105"
                data-main-image
              >
              
              {%- comment -%} Sale Badge - top right {%- endcomment -%}
              {% if product.compare_at_price > product.price %}
                <div class="absolute top-4 right-4 bg-error text-background text-sm font-bold px-3 py-1.5 rounded-full">
                  {% assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price %}
                  -{{ discount }}%
                </div>
              {% endif %}
              
              {%- comment -%} Low Stock Badge {%- endcomment -%}
              {% assign current_variant = product.selected_or_first_available_variant %}
              {% if current_variant.inventory_quantity <= 10 and current_variant.inventory_quantity > 0 %}
                <div class="absolute top-4 left-4 bg-warning text-background text-xs font-semibold px-3 py-1.5 rounded-full">
                  {{ 'products.product.low_stock' | t }} - {{ current_variant.inventory_quantity }} {{ 'general.cart.item_count.other' | t: count: current_variant.inventory_quantity }}
                </div>
              {% endif %}
            </div>
            
            {%- comment -%} Thumbnails - rounded-lg 8px {%- endcomment -%}
            {% if product.media.size > 1 %}
              <div class="product-thumbnails mt-4 grid grid-cols-2 gap-3">
                {% for media in product.media limit: 4 %}
                  <div 
                    class="thumbnail relative bg-background overflow-hidden transition-all duration-200"
                    ref="thumbnails[]"
                    on:click="/selectSlide/{{ forloop.index0 }}"
                    data-media-id="{{ media.id }}"
                    aria-label="Switch to image {{ forloop.index }}"
                  >
                    {% if media.media_type == 'video' or media.media_type == 'external_video' %}
                      <img
                        src="{{ media.preview_image | image_url: width: 600 }}"
                        alt="{{ media.alt | default: product.title }}"
                        loading="lazy"
                        class="w-full aspect-square object-cover"
                      >
                      <div class="absolute inset-0 flex items-center justify-center bg-black/20">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path>
                        </svg>
                      </div>
                    {% else %}
                      <img
                        src="{{ media.preview_image | image_url: width: 600 }}"
                        alt="{{ media.alt | default: product.title }}"
                        loading="lazy"
                        class="w-full aspect-square object-cover"
                      >
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          </product-gallery-component>
        {% endif %}
        
        {%- comment -%} Trust Badges {%- endcomment -%}
        <div class="trust-badges"></div> 
      </div>
      
      {%- comment -%} Right: Product Info & Buy Area {%- endcomment -%}
      <div class="product-info">
        {%- comment -%} Vendor - Small Label {%- endcomment -%}
        {% if product.vendor != blank %}
          <a href="{{ product.vendor | url_for_vendor }}" class="inline-flex items-center text-xs font-medium text-primary hover:text-secondary mb-3 transition-colors">
            {{ product.vendor }}
            <svg class="w-3.5 h-3.5 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </a>
        {% endif %}

        <product-form-component
          class="product-form-wrapper"
          data-product-id="{{ product.id }}"
          data-section-id="{{ section.id }}"
          data-product-url="{{ product.url }}"
          on:submit="/handleSubmit"
        >
          <div
            class="visually-hidden"
            aria-live="assertive"
            role="status"
            aria-atomic="true"
            ref="liveRegion"
          ></div>
          
          {% form 'product', product, class: 'product-form space-y-6', data-type: 'add-to-cart-form' %}
            <input 
              type="hidden" 
              name="id" 
              value="{{ product.selected_or_first_available_variant.id }}"
              ref="variantId"
            >
            {% assign current_variant = product.selected_or_first_available_variant %}
            {% if section.blocks.size > 0 %}
              {% assign has_purchase_blocks = true %}
            {% else %}
              {% assign has_purchase_blocks = false %}
            {% endif %}
            {% if has_purchase_blocks %}
              {% for block in section.blocks %}
                {% assign block_type = block.type %}
                {% assign block_attributes = block.shopify_attributes %}
                {% case block_type %}
                  {% when 'product_title' %}
                    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-text leading-tight mb-6" {{ block_attributes }}>
                      {{ product.title }}
                    </h1>
                  {% when 'product_price' %}
                    <div class="product-price bg-background rounded-2xl mb-8" {{ block_attributes }}>
                      <div class="flex items-baseline gap-3 mb-6">
                        {% if product.compare_at_price > product.price %}
                          <span class="text-4xl text-text">
                            {{ product.price | money }}
                          </span>
                          <span class="text-2xl font-medium text-text-secondary line-through">
                            {{ product.compare_at_price | money }}
                          </span>
                          <span class="inline-flex items-center px-3 py-1 bg-error text-background text-sm font-bold rounded-full">
                            {{ 'products.product.save_amount' | t: amount: product.compare_at_price | minus: product.price | money }}
                          </span>
                        {% else %}
                          <span class="text-4xl text-text">
                            {{ product.price | money }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  {% when 'product_description' %}
                    {% if product.description != blank %}
                      <div class="product-short-description text-base leading-relaxed text-text-secondary mb-6 pb-6" {{ block_attributes }}>
                        {{ product.description | strip_html | truncate: 200 }}
                      </div>
                    {% endif %}
                  {% when 'variant_selector' %}
                    {% unless product.has_only_default_variant %}
                      <div {{ block_attributes }}>
                        <variant-selector-component 
                          class="product-variants space-y-5"
                          data-product-id="{{ product.id }}"
                          data-product-url="{{ product.url }}"
                          data-section-id="{{ section.id }}"
                          data-product-page="true"
                        >
                          <script type="application/json">
                            {{ product | json }}
                          </script>
                          
                          {% for option in product.options_with_values %}
                            <div class="variant-option">
                              <label class="block text-sm font-semibold text-text mb-3">
                                {{ option.name }}
                                <span class="font-normal text-text-secondary ml-2" data-selected-value-{{ option.name | handle }}>
                                  {% if option.selected_value %}
                                    - {{ option.selected_value }}
                                  {% endif %}
                                </span>
                              </label>
                              <div class="variant-buttons flex flex-wrap gap-2" role="radiogroup">
                                {% for value in option.values %}
                                  {%- assign variant_for_value = product.variants | where: "option1", value | first -%}
                                  {%- if option.position == 2 -%}
                                    {%- assign variant_for_value = product.variants | where: "option2", value | first -%}
                                  {%- elsif option.position == 3 -%}
                                    {%- assign variant_for_value = product.variants | where: "option3", value | first -%}
                                  {%- endif -%}
                                  <div class="variant-button-wrapper">
                                    <input
                                      type="radio"
                                      id="Option-{{ option.name | handle }}-{{ value | handle }}"
                                      name="options[{{ option.name }}]"
                                      value="{{ value }}"
                                      class="sr-only peer"
                                      data-variant-id="{{ variant_for_value.id }}"
                                      data-variant-image="{{ variant_for_value.featured_image | image_url: width: 1200 }}"
                                      {% if option.selected_value == value %}checked{% endif %}
                                      {% unless variant_for_value.available %}disabled{% endunless %}
                                    >
                                    <label
                                      for="Option-{{ option.name | handle }}-{{ value | handle }}"
                                      class="inline-flex items-center justify-center min-w-[60px] px-4 py-2.5 text-sm font-medium rounded-lg border cursor-pointer transition-all duration-200
                                             {% if variant_for_value.available %}
                                               border-border/80 bg-background text-text hover:border-border
                                               peer-checked:border-primary peer-checked:bg-primary peer-checked:text-background
                                             {% else %}
                                               border-border/60 bg-border/15 text-text-secondary/60 cursor-not-allowed line-through
                                             {% endif %}"
                                    >
                                      {{ value }}
                                    </label>
                                  </div>
                                {% endfor %}
                              </div>
                            </div>
                          {% endfor %}
                          
                          <div data-variant-error class="hidden text-sm font-medium text-error p-3 bg-error/10 border border-error/30 rounded-lg"></div>
                        </variant-selector-component>
                      </div>
                    {% endunless %}
                  {% when 'quantity_selector' %}
                    <div class="flex items-start gap-4" {{ block_attributes }}>
                      <div class="flex-shrink-0">
                        <label class="block text-sm font-semibold text-text mb-3">
                          {{ 'products.product.quantity' | t }}
                        </label>
                        {% render 'quantity-input', 
                          variant_id: current_variant.id,
                          value: 1,
                          min: 1,
                          label: product.title
                        %}
                      </div>
                    </div>
                  {% when 'buy_buttons' %}
                    <div class="space-y-4" {{ block_attributes }}>
                      <span class="hidden w-full text-sm font-medium text-error p-4 bg-error/10 border border-error/30 rounded-lg" ref="addToCartTextError" role="alert"></span>
                      {% if current_variant.available %}
                        {% assign product_variant_media = current_variant.featured_media.preview_image | image_url: width: 100 %}
                        {% if product_variant_media == blank %}
                          {% assign product_variant_media = product.featured_media.preview_image | image_url: width: 100 %}
                        {% endif %}
                        <add-to-cart-component
                          ref="addToCartButtonContainer"
                          data-product-variant-media="{{ product_variant_media }}"
                          data-add-to-cart-animation="false"
                          class="block"
                        >
                          <button 
                            type="submit"
                            name="add"
                            ref="addToCartButton"
                            on:click="/handleClick"
                            data-add-to-cart-button
                            class="relative w-full px-8 py-4 text-lg font-bold text-background rounded-xl shadow-lg bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary active:scale-[0.99]"
                          >
                            <span class="flex items-center justify-center gap-3">
                              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                              </svg>
                              <span data-add-to-cart-text>{{ 'products.product.add_to_cart' | t }}</span>
                            </span>
                            <span class="absolute inset-0 flex items-center justify-center gap-2 text-base font-semibold text-background transition-opacity duration-200 opacity-0 pointer-events-none" ref="addToCartSuccess">
                              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                              </svg>
                              <span>{{ 'products.product.added' | t }}</span>
                            </span>
                          </button>
                        </add-to-cart-component>
                        <div class="dynamic-checkout-button w-full mt-3">
                          {{ form | payment_button }}
                        </div>
                      {% else %}
                        <button 
                          type="button"
                          disabled
                          class="w-full px-8 py-4 text-lg font-bold text-background bg-text-secondary/40 rounded-lg cursor-not-allowed opacity-60"
                        >
                          {{ 'products.product.sold_out' | t }}
                        </button>
                      {% endif %}
                    </div>
                {% endcase %}
              {% endfor %}
            {% else %}
              {% assign default_block_order = 'product_title|product_price|product_description|variant_selector|quantity_selector|buy_buttons' | split: '|' %}
              {% for fallback_block in default_block_order %}
                {% assign block_type = fallback_block %}
                {% assign block_attributes = '' %}
                {% case block_type %}
                  {% when 'product_title' %}
                    <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-text leading-tight mb-6">
                      {{ product.title }}
                    </h1>
                  {% when 'product_price' %}
                    <div class="product-price bg-background rounded-2xl mb-8">
                      <div class="flex items-baseline gap-3 mb-6">
                        {% if product.compare_at_price > product.price %}
                          <span class="text-4xl text-text">
                            {{ product.price | money }}
                          </span>
                          <span class="text-2xl font-medium text-text-secondary line-through">
                            {{ product.compare_at_price | money }}
                          </span>
                          <span class="inline-flex items-center px-3 py-1 bg-error text-background text-sm font-bold rounded-full">
                            {{ 'products.product.save_amount' | t: amount: product.compare_at_price | minus: product.price | money }}
                          </span>
                        {% else %}
                          <span class="text-4xl text-text">
                            {{ product.price | money }}
                          </span>
                        {% endif %}
                      </div>
                    </div>
                  {% when 'product_description' %}
                    {% if product.description != blank %}
                      <div class="product-short-description text-base leading-relaxed text-text-secondary mb-6 pb-6">
                        {{ product.description | strip_html | truncate: 200 }}
                      </div>
                    {% endif %}
                  {% when 'variant_selector' %}
                    {% unless product.has_only_default_variant %}
                      <variant-selector-component 
                        class="product-variants space-y-5"
                        data-product-id="{{ product.id }}"
                        data-product-url="{{ product.url }}"
                        data-section-id="{{ section.id }}"
                        data-product-page="true"
                      >
                        <script type="application/json">
                          {{ product | json }}
                        </script>
                        {% for option in product.options_with_values %}
                          <div class="variant-option">
                            <label class="block text-sm font-semibold text-text mb-3">
                              {{ option.name }}
                              <span class="font-normal text-text-secondary ml-2" data-selected-value-{{ option.name | handle }}>
                                {% if option.selected_value %}
                                  - {{ option.selected_value }}
                                {% endif %}
                              </span>
                            </label>
                            <div class="variant-buttons flex flex-wrap gap-2" role="radiogroup">
                              {% for value in option.values %}
                                {%- assign variant_for_value = product.variants | where: "option1", value | first -%}
                                {%- if option.position == 2 -%}
                                  {%- assign variant_for_value = product.variants | where: "option2", value | first -%}
                                {%- elsif option.position == 3 -%}
                                  {%- assign variant_for_value = product.variants | where: "option3", value | first -%}
                                {%- endif -%}
                                <div class="variant-button-wrapper">
                                  <input
                                    type="radio"
                                    id="Option-{{ option.name | handle }}-{{ value | handle }}"
                                    name="options[{{ option.name }}]"
                                    value="{{ value }}"
                                    class="sr-only peer"
                                    data-variant-id="{{ variant_for_value.id }}"
                                    data-variant-image="{{ variant_for_value.featured_image | image_url: width: 1200 }}"
                                    {% if option.selected_value == value %}checked{% endif %}
                                    {% unless variant_for_value.available %}disabled{% endunless %}
                                  >
                                  <label
                                    for="Option-{{ option.name | handle }}-{{ value | handle }}"
                                  class="inline-flex items-center justify-center min-w-[60px] px-4 py-2.5 text-sm font-medium rounded-lg border cursor-pointer transition-all duration-200
                                         {% if variant_for_value.available %}
                                           border-border/80 bg-background text-text hover:border-border
                                           peer-checked:border-primary peer-checked:bg-primary peer-checked:text-background
                                         {% else %}
                                           border-border/60 bg-border/15 text-text-secondary/60 cursor-not-allowed line-through
                                         {% endif %}"
                                  >
                                    {{ value }}
                                  </label>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        {% endfor %}
                        
                        <div data-variant-error class="hidden text-sm font-medium text-error p-3 bg-error/10 border border-error/30 rounded-lg"></div>
                      </variant-selector-component>
                    {% endunless %}
                  {% when 'quantity_selector' %}
                    <div class="flex items-start gap-4">
                      <div class="flex-shrink-0">
                        <label class="block text-sm font-semibold text-text mb-3">
                          {{ 'products.product.quantity' | t }}
                        </label>
                        {% render 'quantity-input', 
                          variant_id: current_variant.id,
                          value: 1,
                          min: 1,
                          label: product.title
                        %}
                      </div>
                    </div>
                  {% when 'buy_buttons' %}
                    <div class="space-y-4">
                      <span class="hidden w-full text-sm font-medium text-error p-4 bg-error/10 border border-error/30 rounded-lg" ref="addToCartTextError" role="alert"></span>
                      {% if current_variant.available %}
                        {% assign product_variant_media = current_variant.featured_media.preview_image | image_url: width: 100 %}
                        {% if product_variant_media == blank %}
                          {% assign product_variant_media = product.featured_media.preview_image | image_url: width: 100 %}
                        {% endif %}
                        <add-to-cart-component
                          ref="addToCartButtonContainer"
                          data-product-variant-media="{{ product_variant_media }}"
                          data-add-to-cart-animation="false"
                          class="block"
                        >
                          <button 
                            type="submit"
                            name="add"
                            ref="addToCartButton"
                            on:click="/handleClick"
                            data-add-to-cart-button
                            class="relative w-full px-8 py-4 text-lg font-bold text-background rounded-xl shadow-lg bg-gradient-to-r from-primary to-secondary hover:from-secondary hover:to-primary transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary active:scale-[0.99]"
                          >
                            <span class="flex items-center justify-center gap-3">
                              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                              </svg>
                              <span data-add-to-cart-text>{{ 'products.product.add_to_cart' | t }}</span>
                            </span>
                            <span class="absolute inset-0 flex items-center justify-center gap-2 text-base font-semibold text-background transition-opacity duration-200 opacity-0 pointer-events-none" ref="addToCartSuccess">
                              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                              </svg>
                              <span>{{ 'products.product.added' | t }}</span>
                            </span>
                          </button>
                        </add-to-cart-component>
                        <div class="dynamic-checkout-button w-full mt-3">
                          {{ form | payment_button }}
                        </div>
                      {% else %}
                        <button 
                          type="button"
                          disabled
                          class="w-full px-8 py-4 text-lg font-bold text-background bg-text-secondary/40 rounded-lg cursor-not-allowed opacity-60"
                        >
                          {{ 'products.product.sold_out' | t }}
                        </button>
                      {% endif %}
                    </div>
                {% endcase %}
              {% endfor %}
            {% endif %}
          {% endform %}
        </product-form-component>
      </div>
    </div>
  </div>
</div>

{%- comment -%} Sticky Add to Cart Bar (Mobile) {%- endcomment -%}
<div class="lg:hidden fixed bottom-0 inset-x-0 bg-background/95 backdrop-blur z-40 transform translate-y-full transition-transform duration-300" id="stickyCartBar">
  <div class="px-4 py-3 flex items-center gap-3">
    <div class="flex-1 min-w-0">
      <p class="text-xs text-text-secondary truncate">{{ product.title }}</p>
      <p class="text-lg font-bold text-text">{{ product.price | money }}</p>
    </div>
    <button 
      type="button"
      onclick="document.querySelector('form.product-form').requestSubmit()"
      class="flex-shrink-0 inline-flex items-center gap-2 px-6 py-3 text-base font-bold text-background bg-primary rounded-lg active:scale-95 transition-transform"
      data-sticky-add-to-cart
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
      </svg>
      <span data-sticky-cart-text>{{ 'products.product.add_to_cart' | t }}</span>
    </button>
  </div>
</div>

{%- comment -%} JavaScript for Sticky Bar and Variant Image Switch {%- endcomment -%}
<script>
(function() {
  // Sticky cart bar on scroll (mobile only)
  if (window.innerWidth < 1024) {
    let lastScroll = 0;
    const stickyBar = document.getElementById('stickyCartBar');
    const productForm = document.querySelector('.product-form-wrapper');
    
    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;
      const formRect = productForm.getBoundingClientRect();
      const isFormVisible = formRect.top < window.innerHeight && formRect.bottom > 0;
      
      if (!isFormVisible && currentScroll > lastScroll) {
        // Scrolling down and form is not visible
        stickyBar.style.transform = 'translateY(0)';
      } else {
        // Scrolling up or form is visible
        stickyBar.style.transform = 'translateY(100%)';
      }
      
      lastScroll = currentScroll;
    });
  }
  
  // Update main image when variant changes
  document.addEventListener('change', function(e) {
    const target = e.target;
    
    // Check if it's a variant input with image data
    if (target.matches('input[name^="options"][data-variant-image]')) {
      const variantImage = target.getAttribute('data-variant-image');
      const mainImage = document.querySelector('[data-main-image]');
      
      if (variantImage && variantImage !== '' && mainImage) {
        mainImage.src = variantImage;
      }

      const variantThumbnail = document.querySelector('[data-variant-thumbnail]');
      if (variantThumbnail && mainImage) {
        variantThumbnail.src = mainImage.src;
        if (mainImage.alt) {
          variantThumbnail.alt = mainImage.alt;
        }
      }

      const thumbnailTrack = document.querySelector('[data-thumbnail-track]');
      if (thumbnailTrack) {
        thumbnailTrack.scrollTo({ left: 0, behavior: 'smooth' });
      }
    }
  });
  
  // Update sold out button text in sticky bar
  const addToCartButton = document.querySelector('[data-add-to-cart-button]');
  const stickyCartButton = document.querySelector('[data-sticky-add-to-cart]');
  const stickyCartText = document.querySelector('[data-sticky-cart-text]');
  
  if (addToCartButton && stickyCartButton) {
    // Sync disabled state
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
          if (addToCartButton.disabled) {
            stickyCartButton.disabled = true;
            stickyCartButton.classList.add('opacity-60', 'cursor-not-allowed', 'bg-text-secondary/40');
            stickyCartButton.classList.remove('bg-primary');
            if (stickyCartText) {
              stickyCartText.textContent = '{{ 'products.product.sold_out' | t }}';
            }
          } else {
            stickyCartButton.disabled = false;
            stickyCartButton.classList.remove('opacity-60', 'cursor-not-allowed', 'bg-text-secondary/40');
            stickyCartButton.classList.add('bg-primary');
            if (stickyCartText) {
              stickyCartText.textContent = '{{ 'products.product.add_to_cart' | t }}';
            }
          }
        }
      });
    });
    
    observer.observe(addToCartButton, { attributes: true });
  }
})();
</script>

{% schema %}
{
  "name": "Main Product",
  "tag": "section",
  "class": "section-main-product",
  "settings": [
  ],
  "blocks": [
    {
      "type": "product_title",
      "name": "Product title",
      "limit": 1
    },
    {
      "type": "product_price",
      "name": "Price",
      "limit": 1
    },
    {
      "type": "product_description",
      "name": "Product description",
      "limit": 1
    },
    {
      "type": "variant_selector",
      "name": "Variant selector",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "Quantity selector",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "Buy buttons",
      "limit": 1
    }
  ],
  "presets": [
    {
      "name": "Main Product",
      "blocks": [
        { "type": "product_title" },
        { "type": "product_price" },
        { "type": "product_description" },
        { "type": "variant_selector" },
        { "type": "quantity_selector" },
        { "type": "buy_buttons" }
      ]
    }
  ]
}
{% endschema %}
