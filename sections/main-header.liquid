{% comment %}
  Header Section - Modern DTC Design
  Sticky header with show-on-scroll-up behavior
{% endcomment %}

{% liquid
  assign menu_linklist = section.settings.main_menu | default: 'main-menu'
  assign nav_position = section.settings.nav_position | default: 'left'
  assign nav_position_class = 'header__nav--' | append: nav_position
  assign header_logo = settings.logo
  assign header_logo_width = settings.logo_width | default: 150
  assign requested_logo_width = header_logo_width | times: 2

  if requested_logo_width < 100
    assign requested_logo_width = 100
  endif

  if requested_logo_width > 600
    assign requested_logo_width = 600
  endif

  if header_logo != blank and header_logo.alt != blank
    assign header_logo_alt = header_logo.alt
  else
    assign header_logo_alt = shop.name
  endif

  assign header_logo_style = 'max-width: ' | append: header_logo_width | append: 'px'
  assign section_color_scheme = section.settings.color_scheme | default: 'scheme-1'
%}

<header 
  class="color-scheme color-{{ section_color_scheme }} header header--sticky header--blur" 
  data-header
>
  <div class="header__container container-custom">
    <div class="header__inner">
      
      {%comment%} Mobile Menu Toggle {%endcomment%}
      <button 
        type="button"
        class="header__menu-toggle" 
        data-mobile-menu-toggle
        aria-expanded="false"
        aria-label="{{ 'header.menu' | t }}"
        aria-controls="mobile-nav"
      >
        <span class="header__menu-icon">
          <span class="header__menu-icon-line"></span>
          <span class="header__menu-icon-line"></span>
          <span class="header__menu-icon-line"></span>
        </span>
      </button>

      {%comment%} Logo {%endcomment%}
      <div class="header__logo">
        <a href="{{ routes.root_url }}" class="header__logo-link">
          {% if header_logo %}
            {{
              header_logo
              | image_url: width: requested_logo_width
              | image_tag:
                class: 'header__logo-image',
                alt: header_logo_alt,
                loading: 'eager',
                widths: '120,160,200,240,300,360,480,600',
                width: header_logo_width,
                style: header_logo_style
            }}
          {% else %}
            <span class="header__logo-text">{{ shop.name }}</span>
          {% endif %}
        </a>
      </div>

      {%comment%} Desktop Navigation {%endcomment%}
      <nav class="header__nav {{ nav_position_class }}" aria-label="{{ 'header.menu' | t }}">
        {% if linklists[menu_linklist].links.size > 0 %}
          <ul class="header__nav-list">
            {% for link in linklists[menu_linklist].links %}
              <li class="header__nav-item">
                <a 
                  href="{{ link.url }}" 
                  class="header__nav-link"
                >
                  {{ link.title }}
                </a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </nav>

      {%comment%} Header Actions {%endcomment%}
      <div class="header__actions">
        {%comment%} Cart {%endcomment%}
        <a 
          href="{{ routes.cart_url }}" 
          class="header__action-link header__cart-link"
          aria-label="{{ 'header.cart' | t }} ({{ cart.item_count }} {{ 'header.items' | t }})"
        >
          {% render 'icon', name: 'cart-outline', class: 'header__icon w-6 h-6' %}
          {% if cart.item_count > 0 %}
            <span class="header__cart-count" data-cart-count>{{ cart.item_count }}</span>
          {% else %}
            <span class="header__cart-count" data-cart-count hidden>0</span>
          {% endif %}
        </a>

        {%comment%} Account {%endcomment%}
        {% if shop.customer_accounts_enabled %}
          <a 
            href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" 
            class="header__action-link header__account-link"
            aria-label="{% if customer %}{{ 'header.account' | t }}{% else %}{{ 'header.log_in' | t }}{% endif %}"
          >
            {% render 'icon', name: 'user', class: 'header__icon w-6 h-6' %}
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {%comment%} Mobile Navigation Drawer {%endcomment%}
  <div 
    id="mobile-nav"
    class="header__mobile-drawer" 
    data-mobile-drawer
    aria-hidden="true"
  >
    <div class="header__mobile-backdrop" data-mobile-backdrop></div>
    <div class="header__mobile-panel">
      <div class="header__mobile-header">
        <div class="header__mobile-logo">
          {% if section.settings.logo %}
            {{
              section.settings.logo
              | image_url: width: 300
              | image_tag:
                alt: shop.name,
                width: 120,
                height: 'auto'
            }}
          {% else %}
            <span class="header__mobile-logo-text">{{ shop.name }}</span>
          {% endif %}
        </div>
        <button 
          type="button"
          class="header__mobile-close" 
          data-mobile-close
          aria-label="{{ 'header.close_menu' | t }}"
        >
          {% render 'icon', name: 'close', class: 'w-6 h-6' %}
        </button>
      </div>
      
      <nav class="header__mobile-nav" aria-label="{{ 'header.menu' | t }}">
        {% if linklists[menu_linklist].links.size > 0 %}
          <ul class="header__mobile-nav-list">
            {% for link in linklists[menu_linklist].links %}
              <li>
                <a 
                  href="{{ link.url }}" 
                  class="header__mobile-nav-link"
                  {% if link.active %}aria-current="page"{% endif %}
                >
                  {{ link.title }}
                </a>
              </li>
            {% endfor %}
            
            {%comment%} Account Link in Mobile {%endcomment%}
            {% if shop.customer_accounts_enabled %}
              <li class="header__mobile-divider">
                <a 
                  href="{% if customer %}{{ routes.account_url }}{% else %}{{ routes.account_login_url }}{% endif %}" 
                  class="header__mobile-nav-link header__mobile-nav-link--highlighted"
                >
                  {% render 'icon', name: 'user', class: 'w-5 h-5' %}
                  <span>
                    {% if customer %}
                      {{ customer.first_name | default: 'Account' }}
                    {% else %}
                      {{ 'header.log_in' | t }}
                    {% endif %}
                  </span>
                </a>
              </li>
            {% endif %}
          </ul>
        {% endif %}
      </nav>
    </div>
  </div>
</header>

{% stylesheet %}
.header {
  color: var(--color-foreground);
  background-color: rgb(var(--color-background-rgb) / 0.90);
  border-bottom: 1px solid rgb(var(--color-border-rgb) / 0.4);
  backdrop-filter: blur(8px);
}
.header__logo-text,
.header__nav-link,
.header__action-link {
  color: rgb(var(--color-foreground-rgb) / 0.85);
}
.header__action-link:hover {
  color: var(--color-primary);
}
.header__icon { color: rgb(var(--color-foreground-rgb) / 0.85); }
.header__cart-count {
  background-color: var(--color-primary);
  color: var(--color-primary-foreground);
}
.header__mobile-drawer { background-color: var(--color-background); color: var(--color-foreground); }
.header__mobile-backdrop { background-color: rgb(var(--color-foreground-rgb) / 0.2); }
{% endstylesheet %}

{% javascript %}
class HeaderComponent {
  constructor() {
    this.header = document.querySelector('[data-header]');
    this.mobileToggle = document.querySelector('[data-mobile-menu-toggle]');
    this.mobileDrawer = document.querySelector('[data-mobile-drawer]');
    this.mobileBackdrop = document.querySelector('[data-mobile-backdrop]');
    this.mobileClose = document.querySelector('[data-mobile-close]');
    
    this.lastScrollY = window.scrollY;
    
    this.init();
  }
  
  init() {
    // Mobile menu handlers
    if (this.mobileToggle) {
      this.mobileToggle.addEventListener('click', () => this.toggleMobileMenu());
    }
    
    if (this.mobileClose) {
      this.mobileClose.addEventListener('click', () => this.closeMobileMenu());
    }
    
    if (this.mobileBackdrop) {
      this.mobileBackdrop.addEventListener('click', () => this.closeMobileMenu());
    }
    
    // Escape key handler
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.mobileDrawer?.getAttribute('aria-hidden') === 'false') {
        this.closeMobileMenu();
      }
    });
    
    // Prevent body scroll when mobile menu is open
    if (this.mobileDrawer) {
      const observer = new MutationObserver(() => {
        const isOpen = this.mobileDrawer.getAttribute('aria-hidden') === 'false';
        document.body.style.overflow = isOpen ? 'hidden' : '';
        document.documentElement.style.overflow = isOpen ? 'hidden' : '';
      });
      
      observer.observe(this.mobileDrawer, {
        attributes: true,
        attributeFilter: ['aria-hidden']
      });
    }
    
    // Scroll handler - always show on scroll up, hide on scroll down
    window.addEventListener('scroll', () => this.handleScroll(), { passive: true });
  }
  
  toggleMobileMenu() {
    const isExpanded = this.mobileToggle.getAttribute('aria-expanded') === 'true';
    
    if (isExpanded) {
      this.closeMobileMenu();
    } else {
      this.openMobileMenu();
    }
  }
  
  openMobileMenu() {
    if (!this.mobileDrawer) return;
    
    this.mobileToggle.setAttribute('aria-expanded', 'true');
    this.mobileDrawer.setAttribute('aria-hidden', 'false');
  }
  
  closeMobileMenu() {
    if (!this.mobileDrawer) return;
    
    this.mobileToggle.setAttribute('aria-expanded', 'false');
    this.mobileDrawer.setAttribute('aria-hidden', 'true');
  }
  
  handleScroll() {
    const currentScrollY = window.scrollY;
    
    // Add scrolled class for styling
    if (currentScrollY > 10) {
      this.header.classList.add('header--scrolled');
    } else {
      this.header.classList.remove('header--scrolled');
    }
    
    // Show on scroll up, hide on scroll down (when scrolled past 100px)
    if (currentScrollY > this.lastScrollY && currentScrollY > 100) {
      // Scrolling down - hide header
      this.header.classList.add('header--hidden');
    } else {
      // Scrolling up - show header
      this.header.classList.remove('header--hidden');
    }
    
    this.lastScrollY = currentScrollY;
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => new HeaderComponent());
} else {
  new HeaderComponent();
}
{% endjavascript %}

{% schema %}
{
  "name": "Main header",
  "class": "section-header",
  "settings": [
    {
      "type": "paragraph",
      "content": "Logo is managed globally via Theme settings â†’ Header."
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Navigation"
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Menu",
      "default": "main-menu"
    },
    {
      "type": "select",
      "id": "nav_position",
      "label": "Navigation position (Desktop)",
      "options": [
        {
          "value": "left",
          "label": "Left (near logo)"
        },
        {
          "value": "center",
          "label": "Center"
        }
      ],
      "default": "left",
      "info": "Choose navigation menu position on desktop"
    }
  ]
}
{% endschema %}
