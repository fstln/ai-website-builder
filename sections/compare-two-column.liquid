{%- comment -%}
  Interactive two-column compare section with selectable products.
{%- endcomment -%}

{%- liquid
  assign fallback_section_id = 'compare-' | append: section.index
  assign section_id = section.settings.section_id | default: fallback_section_id
-%}

{%- liquid
  assign p1 = section.settings.product_col1
  assign p2 = section.settings.product_col2
  assign p3 = section.settings.product_col3
  assign show_cards = section.settings.show_product_cards
  if p1 == blank and product
    assign p1 = product
  endif
  assign has_col2 = false
  assign has_col3 = false
  if p2
    assign has_col2 = true
  else
    for block in section.blocks
      if block.settings.product_b_value != blank
        assign has_col2 = true
        break
      endif
    endfor
  endif
  if p3
    assign has_col3 = true
  else
    for block in section.blocks
      if block.settings.product_c_value != blank
        assign has_col3 = true
        break
      endif
    endfor
  endif
-%}

{%- liquid
  assign col1_title = p1.title | default: section.settings.col1_fallback_label | default: 'Product A'
  assign col2_title = p2.title | default: section.settings.col2_fallback_label | default: 'Product B'
  assign col3_title = p3.title | default: section.settings.col3_fallback_label | default: 'Product C'
  assign col1_image = ''
  if p1 and p1.featured_media
    assign col1_image = p1.featured_media | image_url: width: 900
  endif
  assign col2_image = ''
  if p2 and p2.featured_media
    assign col2_image = p2.featured_media | image_url: width: 900
  endif
  assign col3_image = ''
  if p3 and p3.featured_media
    assign col3_image = p3.featured_media | image_url: width: 900
  endif
  assign col1_url = ''
  if p1 and p1.url
    assign col1_url = p1.url
  endif
  assign col2_url = ''
  if p2 and p2.url
    assign col2_url = p2.url
  endif
  assign col3_url = ''
  if p3 and p3.url
    assign col3_url = p3.url
  endif
  assign default_left_id = 'col1'
  assign default_right_id = ''
  if has_col2
    assign default_right_id = 'col2'
  elsif has_col3
    assign default_right_id = 'col3'
  else
    assign default_right_id = 'col1'
  endif
-%}

{%- capture col1_values -%}
[
{%- for block in section.blocks -%}
  {
    "feature": {{ block.settings.feature_name | json }},
    "value": {{ block.settings.product_a_value | json }}
  }{% unless forloop.last %},{% endunless %}
{%- endfor -%}
]
{%- endcapture -%}
{%- capture col2_values -%}
[
{%- for block in section.blocks -%}
  {
    "feature": {{ block.settings.feature_name | json }},
    "value": {{ block.settings.product_b_value | json }}
  }{% unless forloop.last %},{% endunless %}
{%- endfor -%}
]
{%- endcapture -%}
{%- capture col3_values -%}
[
{%- for block in section.blocks -%}
  {
    "feature": {{ block.settings.feature_name | json }},
    "value": {{ block.settings.product_c_value | json }}
  }{% unless forloop.last %},{% endunless %}
{%- endfor -%}
]
{%- endcapture -%}

{%- capture compare_products_json -%}
[
  {
    "id": "col1",
    "title": {{ col1_title | json }},
    "image": {{ col1_image | json }},
    "url": {{ col1_url | json }},
    "values": {{ col1_values | strip | default: '[]' }}
  }{% if has_col2 %},
  {
    "id": "col2",
    "title": {{ col2_title | json }},
    "image": {{ col2_image | json }},
    "url": {{ col2_url | json }},
    "values": {{ col2_values | strip | default: '[]' }}
  }{% endif %}{% if has_col3 %},
  {
    "id": "col3",
    "title": {{ col3_title | json }},
    "image": {{ col3_image | json }},
    "url": {{ col3_url | json }},
    "values": {{ col3_values | strip | default: '[]' }}
  }{% endif %}
]
{%- endcapture -%}

<section id="{{ section_id | escape }}" class="color-scheme color-{{ section.settings.color_scheme }} bg-background py-16 sm:py-20 lg:py-24">
  <div class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8">
    <div class="mx-auto max-w-2xl lg:text-center">
      <h2 class="text-3xl font-bold tracking-tight text-foreground sm:text-4xl font-heading">
        {{ section.settings.heading }}
      </h2>
      <p class="mt-6 text-lg leading-8 text-muted">
        {{ section.settings.subheading }}
      </p>
    </div>
    <div class="mt-12" data-compare-two-column data-compare-products='{{ compare_products_json | strip | escape }}' data-buy-label="{{ section.settings.buy_now_label | escape }}">
      <div class="grid gap-4 md:gap-6 grid-cols-2">
        <div>
          <select id="compare-left-{{ section.id }}" class="w-full md:rounded-2xl border-b md:border md:border-border/60 md:bg-surface md:px-4 py-3 text-sm md:text-base text-foreground" data-compare-select="left">
            {%- assign option_ids = 'col1,col2,col3' | split: ',' -%}
            {%- for option_id in option_ids -%}
              {%- if option_id == 'col2' and has_col2 == false -%}{% continue %}{%- endif -%}
              {%- if option_id == 'col3' and has_col3 == false -%}{% continue %}{%- endif -%}
              {%- case option_id -%}
                {%- when 'col1' -%}{%- assign option_label = col1_title -%}
                {%- when 'col2' -%}{%- assign option_label = col2_title -%}
                {%- when 'col3' -%}{%- assign option_label = col3_title -%}
              {%- endcase -%}
              <option value="{{ option_id }}"{% if option_id == default_left_id %} selected{% endif %}>{{ option_label }}</option>
            {%- endfor -%}
          </select>
        </div>
        <div>
          <select id="compare-right-{{ section.id }}" class="w-full md:rounded-2xl border-b md:border md:border-border/60 md:bg-surface md:px-4 py-3 text-sm md:text-base text-foreground" data-compare-select="right">
            {%- for option_id in option_ids -%}
              {%- if option_id == 'col2' and has_col2 == false -%}{% continue %}{%- endif -%}
              {%- if option_id == 'col3' and has_col3 == false -%}{% continue %}{%- endif -%}
              {%- case option_id -%}
                {%- when 'col1' -%}{%- assign option_label = col1_title -%}
                {%- when 'col2' -%}{%- assign option_label = col2_title -%}
                {%- when 'col3' -%}{%- assign option_label = col3_title -%}
              {%- endcase -%}
              <option value="{{ option_id }}"{% if option_id == default_left_id %} disabled{% endif %}{% if option_id == default_right_id %} selected{% endif %}>{{ option_label }}</option>
            {%- endfor -%}
          </select>
        </div>
      </div>
      <div class="mt-12 grid grid-cols-2 gap-4 md:gap-6" data-compare-columns>
        {%- assign button_label = section.settings.buy_now_label | default: 'Buy now' -%}
        {%- assign column_ids = default_left_id | append: ',' | append: default_right_id | split: ',' -%}
        {%- for column_id in column_ids -%}
          <div data-compare-column="{% if forloop.index == 1 %}left{% else %}right{% endif %}" data-product-id="{{ column_id }}" data-show-feature-label="true">
            {%- case column_id -%}
              {%- when 'col1' -%}
                {%- assign current_title = col1_title -%}
                {%- assign current_image = col1_image -%}
                {%- assign current_url = col1_url -%}
                {%- assign current_values_key = 'product_a_value' -%}
              {%- when 'col2' -%}
                {%- assign current_title = col2_title -%}
                {%- assign current_image = col2_image -%}
                {%- assign current_url = col2_url -%}
                {%- assign current_values_key = 'product_b_value' -%}
              {%- when 'col3' -%}
                {%- assign current_title = col3_title -%}
                {%- assign current_image = col3_image -%}
                {%- assign current_url = col3_url -%}
                {%- assign current_values_key = 'product_c_value' -%}
              {%- else -%}
                {%- assign current_title = '' -%}
                {%- assign current_image = '' -%}
                {%- assign current_url = '' -%}
                {%- assign current_values_key = 'product_a_value' -%}
            {%- endcase -%}
            <div class="">
              <div class="text-center">
                <div class="aspect-[4/3] rounded-2xl overflow-hidden bg-background/60 flex items-center justify-center">
                  {%- if current_image != blank -%}
                    <img src="{{ current_image }}" alt="{{ current_title | escape }}" class="h-full w-full object-cover" loading="lazy" decoding="async">
                  {%- else -%}
                    <div class="text-sm text-muted">No image</div>
                  {%- endif -%}
                </div>
                <h3 class="mt-4 font-heading text-2xl font-semibold text-foreground" data-column-title>{{ current_title }}</h3>
                {%- if current_url != blank -%}
                  <a href="{{ current_url }}" class="btn btn-primary mt-4 inline-flex items-center justify-center" data-column-cta>{{ button_label }}</a>
                {%- endif -%}
              </div>
              <div class="mt-6 space-y-3" data-column-features>
                {%- for block in section.blocks -%}
                  {%- case current_values_key -%}
                    {%- when 'product_a_value' -%}{%- assign value = block.settings.product_a_value -%}
                    {%- when 'product_b_value' -%}{%- assign value = block.settings.product_b_value -%}
                    {%- when 'product_c_value' -%}{%- assign value = block.settings.product_c_value -%}
                    {%- else -%}{%- assign value = '' -%}
                  {%- endcase -%}
                  <div class="rounded-2xl bg-background/70 px-4 py-3">
                    {%- if block.settings.feature_name != blank -%}
                      <p class="text-xs font-semibold uppercase tracking-wide text-muted">{{ block.settings.feature_name }}</p>
                    {%- endif -%}
                    <p class="mt-2 text-lg text-foreground">{{ value | default: '—' }}</p>
                    <span class="mt-3 block h-px w-full bg-border/60"></span>
                  </div>
                {%- endfor -%}
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </div>
</section>

<script>
(function() {
  const sectionEl = document.getElementById({{ section_id | json }});
  if (!sectionEl) return;
  const root = sectionEl.querySelector('[data-compare-two-column]');
  if (!root || root.dataset.initialized === 'true') return;
  root.dataset.initialized = 'true';
  const productsData = root.getAttribute('data-compare-products');
  let products = [];
  try {
    products = JSON.parse(productsData || '[]');
  } catch (e) {
    products = [];
  }
  if (!products.length) return;
  const buyLabel = root.getAttribute('data-buy-label') || 'Buy now';
  const selects = {
    left: root.querySelector('[data-compare-select="left"]'),
    right: root.querySelector('[data-compare-select="right"]')
  };
  const columns = {
    left: root.querySelector('[data-compare-column="left"]'),
    right: root.querySelector('[data-compare-column="right"]')
  };

  const escapeHtml = (value) => {
    if (typeof value !== 'string') {
      return value == null ? '' : String(value);
    }
    return value.replace(/[&<>"']/g, (char) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    }[char] || char));
  };

  const renderColumn = (target, product) => {
    if (!target || !product) return;
    const showFeatureLabel = target.dataset.showFeatureLabel === 'true';
    const imageMarkup = product.image
      ? `<img src="${product.image}" alt="${escapeHtml(product.title || '')}" class="h-full w-full object-cover" loading="lazy" decoding="async">`
      : '<div class="text-sm text-muted">No image</div>';
    const ctaMarkup = product.url
      ? `<a href="${product.url}" class="btn btn-primary mt-4 inline-flex items-center justify-center">${escapeHtml(buyLabel)}</a>`
      : '';
    const values = Array.isArray(product.values) ? product.values : [];
    const featuresHtml = values.map((item) => {
      const feature = item && item.feature ? `<p class="text-xs font-semibold uppercase tracking-wide text-muted">${escapeHtml(item.feature)}</p>` : '';
      const value = item && item.value ? escapeHtml(item.value) : '—';
      return `<div class="rounded-2xl bg-background/70 px-4 py-3">${feature}<p class="mt-2 text-lg text-foreground">${value}</p><span class="mt-3 block h-px w-full bg-border/60"></span></div>`;
    }).join('');
    target.innerHTML = `
      <div class="">
        <div class="text-center">
          <div class="aspect-[4/3] rounded-2xl overflow-hidden bg-background/60 flex items-center justify-center">${imageMarkup}</div>
          <h3 class="mt-4 font-heading text-base md:text-2xl font-semibold text-foreground">${escapeHtml(product.title || '')}</h3>
          ${ctaMarkup}
        </div>
        <div class="mt-6 space-y-3">${featuresHtml}</div>
      </div>`;
    target.dataset.productId = product.id;
  };

  const updateDisabledOptions = () => {
    if (!(selects.left && selects.right)) return;
    const leftValue = selects.left.value;
    const rightValue = selects.right.value;
    Array.from(selects.right.options).forEach((opt) => {
      opt.disabled = opt.value === leftValue;
    });
    if (selects.right.value === leftValue) {
      const replacement = Array.from(selects.right.options).find((opt) => !opt.disabled);
      if (replacement) {
        selects.right.value = replacement.value;
      }
    }
    Array.from(selects.left.options).forEach((opt) => {
      opt.disabled = opt.value === selects.right.value;
    });
    if (selects.left.value === selects.right.value) {
      const replacement = Array.from(selects.left.options).find((opt) => !opt.disabled);
      if (replacement) {
        selects.left.value = replacement.value;
      }
    }
  };

  const syncColumn = (side) => {
    const select = selects[side];
    const column = columns[side];
    if (!select || !column) return;
    const product = products.find((item) => item.id === select.value) || products[0];
    renderColumn(column, product);
  };

  ['left', 'right'].forEach((side) => {
    const select = selects[side];
    if (!select) return;
    select.addEventListener('change', () => {
      updateDisabledOptions();
      syncColumn(side);
    });
  });

  updateDisabledOptions();
  syncColumn('left');
  syncColumn('right');
})();
</script>

{% schema %}
{
  "name": "Compare (Two column)",
  "tag": "section",
  "class": "compare-two-column",
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "text",
      "id": "section_id",
      "label": "Section ID",
      "info": "Used for anchor links. Defaults to compare-{index} when left blank."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Compare Our Models"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Choose any two models to compare side by side."
    },
    { "type": "header", "content": "Products" },
    {
      "type": "product",
      "id": "product_col1",
      "label": "Product A"
    },
    {
      "type": "product",
      "id": "product_col2",
      "label": "Product B"
    },
    {
      "type": "product",
      "id": "product_col3",
      "label": "Product C"
    },
    {
      "type": "checkbox",
      "id": "show_product_cards",
      "label": "(Deprecated) Show product cards",
      "default": false
    },
    {
      "type": "text",
      "id": "buy_now_label",
      "label": "Buy button label",
      "default": "Buy now"
    },
    { "type": "header", "content": "Fallback labels" },
    { "type": "text", "id": "col1_fallback_label", "label": "Product A label", "default": "Product A" },
    { "type": "text", "id": "col2_fallback_label", "label": "Product B label", "default": "Product B" },
    { "type": "text", "id": "col3_fallback_label", "label": "Product C label", "default": "Product C" }
  ],
  "blocks": [
    {
      "type": "comparison_row",
      "name": "Comparison Row",
      "settings": [
        {
          "type": "text",
          "id": "feature_name",
          "label": "Feature name",
          "default": "Battery Life"
        },
        {
          "type": "text",
          "id": "product_a_value",
          "label": "Product A value",
          "default": "—"
        },
        {
          "type": "text",
          "id": "product_b_value",
          "label": "Product B value",
          "default": "—"
        },
        {
          "type": "text",
          "id": "product_c_value",
          "label": "Product C value",
          "default": "—"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Compare (two column)",
      "blocks": [
        { "type": "comparison_row" },
        { "type": "comparison_row" },
        { "type": "comparison_row" }
      ]
    }
  ]
}
{% endschema %}
